---
title: "e1_child_analysis"
output: pdf_document
date: "2025-07-24"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(ggplot2)
library(viridis)
library(tidyboot)
library(lme4)
library(broom.mixed)
library(svglite)
library(ggthemes)
knitr::opts_chunk$set(message=FALSE, warning=FALSE)
```

```{r, eval = FALSE, include = FALSE}
raw_data <- list.files( path=here("../data/e1_child_raw_data"), full.names=TRUE ) %>% 
  map_dfr( read_csv )

raw_subjects <- read_csv(here("../data/child_pilot_subject_sheet_raw.csv"))

data <- raw_data %>%
  filter(participant_id > 0,  # get rid of debug runs
         participant_age > 0,
         participant_age < 6) %>%
  mutate(participant_id = if_else(participant_id == 15 & participant_age == 4, 14, participant_id), # manually fix errors in age + id logging
         participant_age = if_else(participant_id == 14, 3, participant_age), # all errors reported by RAs and logged correctly in participant sheet
         participant_id = if_else(participant_id == 16 & as.character(session_time) == "15:21:46", 17, participant_id),
         participant_id = if_else(participant_id == 17 & as.character(session_time) == "15:33:15", 18, participant_id),
         participant_age = if_else(participant_id == 18 & as.character(session_time) == "15:33:15", 3, participant_age),
         participant_id = if_else(participant_id == 48 & as.character(session_time) == "14:21:16", 55, participant_id)) %>% # note: we've moved a second participant 48 to subid 55, but this participant currently doesn't have a row in our separate participant sheet
  filter(participant_id != 43) %>% # exclude second run of participant who was run twice
  left_join(raw_subjects %>% select(-child_name), by = c("participant_id" = "sub_id")) %>%
  mutate(exact_age = as.numeric(mdy(experiment_date) - mdy(date_of_birth))/30.43)

#write_csv(data, here("../data/e1_child_data.csv"))
```

```{r, include = FALSE}
data <- read_csv(here("../data/e1_child_data.csv"))

data <- data %>%
  mutate(stimulus_subclass = str_remove(image_name, "^[^_]*_"),
         stimulus_subclass = str_remove(stimulus_subclass, "_.*")) %>%
  mutate(typicality = typicality - 1)

n_kids <- data %>% count(participant_id) %>% nrow()

n_three <- data %>% filter(participant_age == 3) %>% count(participant_id) %>% nrow()
n_four <- data %>% filter(participant_age == 4) %>% count(participant_id) %>% nrow()
n_five <- data %>% filter(participant_age == 5) %>% count(participant_id) %>% nrow()

practice_exclusions <- data %>%
  filter(trial_number <= 1) %>%
  mutate(accuracy = if_else(str_remove(word, "s") == stimulus_subclass, 1, 0)) %>%
  group_by(participant_id) %>%
  summarise(n_correct = sum(accuracy)) %>%
  filter(n_correct < 4)

data <- data %>%
  filter(!(participant_id %in% practice_exclusions$participant_id))
```

We currently have `r n_kids` child participants in the study: `r n_three` three-year-olds, `r n_four` four-year-olds, and `r n_five` five-year-olds.

```{r, eval=FALSE, include = FALSE}
data %>%
  ggplot(aes(x = rt)) +
  geom_histogram()
```

```{r}
data %>%
  mutate(x_position = (image_location + 1) %% 4,
         y_position = case_when(image_location <= 3 ~ 3,
                                image_location <= 7 ~ 2,
                                .default = 1)) %>% 
  count(participant_age, x_position, y_position) %>% 
  ggplot(aes(x = x_position, y = y_position, fill = n)) +
  geom_tile() +
  facet_wrap(~participant_age)
```

Heatmap of where on the screen children tapped, by age. Possibly a slight bias toward the left and right edges and middle row (likely where their hands rest). Image positions were randomized so this isn't a confound.

```{r}
data %>%
  filter(trial_number <= 1) %>%
  mutate(accuracy = if_else(str_remove(word, "s") == stimulus_subclass, 1, 0)) %>%
  group_by(participant_id, exact_age) %>%
  summarise(mean_acc = mean(accuracy)) %>% 
  ggplot(aes(x = exact_age, y = mean_acc, alpha = 0.5)) +
  geom_point(height = 0, width = 0.2)
```

Accuracy on practice trials ("Tap on two carrots" and "Tap on two apples"). Almost all children choose 100% accurately.

```{r}
p <- data %>%
  filter(trial_number > 1) %>%
  group_by(participant_id, condition, trial_number) %>%
  summarise(n_distinct = n_distinct(stimulus_subclass) - 1) %>%
  ungroup() %>%
  group_by(condition) %>%
  tidyboot_mean(n_distinct) %>%
  ungroup() %>%
  ggplot(aes(x = condition, y = mean)) + 
  geom_pointrange(aes(ymin = ci_lower, ymax = ci_upper)) +
  ylab("proportion choices of multiple types")  +
  theme_few() + theme(
  panel.background = element_rect(fill = "transparent",
                                  colour = NA_character_), # necessary to avoid drawing panel outline
  panel.grid.major = element_blank(), # get rid of major grid
  panel.grid.minor = element_blank(), # get rid of minor grid
  plot.background = element_rect(fill = "transparent",
                                 colour = NA_character_), # necessary to avoid drawing plot outline
  legend.background = element_rect(fill = "transparent"),
  legend.box.background = element_rect(fill = "transparent"),
  legend.key = element_rect(fill = "transparent")
)

ggsave(
  plot = p,
  filename = here("plots/pilot_child_types_effect.svg"),
  bg = "transparent",
  height = 5,
  width = 5)
```

Choices of multiple subtypes of stimuli. Our prediction is that children choose multiple subtypes more often when prompted with a familiar word (sampling across the category) and choose one subtype more often when prompted with a novel word (inferring the novel word refers to a specific subtype of the category). Children are currently patterning in line with our prediction.

```{r}
p <- data %>%
  filter(trial_number > 1) %>%
  group_by(condition, participant_id) %>%
  summarise(prop_atypical = sum(typicality)/n()) %>%
  ungroup() %>%
  group_by(condition) %>%
  tidyboot_mean(prop_atypical) %>%
  ungroup() %>%
  ggplot(aes(x = condition, y = mean)) + 
  geom_pointrange(aes(ymin = ci_lower, ymax = ci_upper)) +
  ylab("proportion atypical choices")  +
  theme_few() + theme(
  panel.background = element_rect(fill = "transparent",
                                  colour = NA_character_), # necessary to avoid drawing panel outline
  panel.grid.major = element_blank(), # get rid of major grid
  panel.grid.minor = element_blank(), # get rid of minor grid
  plot.background = element_rect(fill = "transparent",
                                 colour = NA_character_), # necessary to avoid drawing plot outline
  legend.background = element_rect(fill = "transparent"),
  legend.box.background = element_rect(fill = "transparent"),
  legend.key = element_rect(fill = "transparent")
)

ggsave(
  plot = p,
  filename = here("plots/pilot_child_atypical_effect.svg"),
  bg = "transparent",
  height = 5,
  width = 5)
```

Choices of atypical stimuli. Our prediction is that children will choose more typical stimuli when prompted with a familiar word, and will choose more atypical stimuli when prompted with a novel word (inferring the novel word refers to an atypical subtype of the category). Children are patterning in line with our prediction.

```{r}
data %>%
  filter(trial_number > 1) %>%
  group_by(participant_id, condition, category, participant_age, trial_number) %>%
  summarise(n_distinct = n_distinct(stimulus_subclass) - 1) %>%
  ungroup() %>%
  group_by(condition, participant_age) %>%
  tidyboot_mean(n_distinct) %>%
  ungroup() %>%
  ggplot(aes(x = condition, y = mean)) + 
  geom_pointrange(aes(ymin = ci_lower, ymax = ci_upper)) +
  ylab("proportion choices of multiple types") +
  facet_wrap(~participant_age)

```

```{r}
data %>%
  filter(trial_number > 1) %>%
  group_by(condition, participant_age, participant_id) %>%
  summarise(prop_atypical = sum(typicality)/n()) %>%
  ungroup() %>%
  group_by(condition, participant_age) %>%
  tidyboot_mean(prop_atypical) %>%
  ungroup() %>%
  ggplot(aes(x = condition, y = mean)) + 
  geom_pointrange(aes(ymin = ci_lower, ymax = ci_upper)) +
  ylab("proportion atypical choices") +
  facet_wrap(~participant_age)

```

```{r}
data %>%
  filter(trial_number > 1) %>%
  group_by(participant_id, condition, category, trial_number) %>%
  summarise(n_distinct = n_distinct(stimulus_subclass) - 1) %>%
  ungroup() %>%
  group_by(condition, category) %>%
  tidyboot_mean(n_distinct) %>%
  ungroup() %>%
  ggplot(aes(x = condition, y = mean)) + 
  geom_pointrange(aes(ymin = ci_lower, ymax = ci_upper)) +
  facet_wrap(~category) +
  ylab("proportion choices of multiple types")

```

Choices of multiple types, by stimulus item.

```{r}
p <- data %>%
  filter(trial_number > 1) %>%
  group_by(condition, participant_id, category) %>%
  summarise(prop_atypical = sum(typicality)/n()) %>%
  ungroup() %>%
  group_by(condition, category) %>%
  tidyboot_mean(prop_atypical) %>% 
  ungroup() %>%
  ggplot(aes(x = condition, y = mean)) + 
  geom_pointrange(aes(ymin = ci_lower, ymax = ci_upper)) +
  facet_wrap(~category) +
  ylab("proportion atypical choices")
```

Choices of atypical items, by stimulus item. Mushrooms are potentially a difficult item.

```{r}
mean_age <- data %>%
  distinct(participant_id, exact_age) %>%
  summarise(mean_age = mean(exact_age, na.rm = TRUE)) %>%
  pull()

model_data <- data %>%
  filter(trial_number > 1) %>%
  group_by(participant_id, exact_age, condition, category, trial_number) %>%
  summarise(n_distinct = n_distinct(stimulus_subclass) - 1,
            n_atypical = sum(typicality)) %>%
  ungroup() %>%
  mutate(participant_id = as.factor(participant_id),
         exact_age = exact_age - mean_age,
         condition = as.factor(condition))

data %>%
  filter(trial_number > 1) %>%
  group_by(condition) %>%
  summarise(mean = mean(typicality))

contrasts(model_data$condition) = contr.sum(2)

glmer(cbind(n_atypical, 2-n_atypical) ~ condition * exact_age + (1 | participant_id) + (1 | category), family = "binomial",
      data = model_data) %>%
  tidy()
```

```{r}
model_data %>%
  group_by(participant_id, exact_age, condition) %>%
  summarise(prop_multiple = mean(n_distinct)) %>% 
  ggplot(aes(x = prop_multiple)) +
  geom_histogram() +
  facet_wrap(~condition)


glmer(n_distinct ~ condition * exact_age + (1 | category) + (1 | participant_id), family = "binomial",
      data = model_data) %>%
  tidy()
```
